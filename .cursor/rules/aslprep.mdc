---
globs: "*.py"
---
# ASLPrep Project Rules

## Project Identity

- Package: `aslprep` -- ASL perfusion MRI preprocessing BIDS App
- Default branch: `main`
- Entry point: [aslprep/cli/run.py](mdc:aslprep/cli/run.py)

## Linting & Formatting

- Linter/formatter: ruff ~= 0.15.0
- Config: [pyproject.toml](mdc:pyproject.toml) under `[tool.ruff]`
- Pre-commit: [.pre-commit-config.yaml](mdc:.pre-commit-config.yaml) with ruff v0.6.2
- Black is disabled (`[tool.black] exclude = ".*"`)
- Suppressed rules: UP031 (old-style formatting, fix incrementally), S311, ISC001, S603

## Version Management

- Uses `__about__.py` pattern: [aslprep/__about__.py](mdc:aslprep/__about__.py)
- Exports `__version__`, `__packagename__`, `__copyright__`, `__credits__`
- `_version.py` is auto-generated by hatch-vcs; `__about__.py` imports from it

## Heavy NiPreps Dependency Chain

ASLPrep depends heavily on the fMRIPrep/NiPreps stack:
- `fmriprep ~= 25.2.2`: Reuses anatomical and fieldmap workflows
- `sdcflows ~= 2.15.0`: Susceptibility distortion correction
- `smriprep ~= 0.19.1`: Structural MRI preprocessing
- `niworkflows ~= 1.14.2`: Shared workflow components
When updating these, check for breaking API changes across the stack.

## Test Extras Naming

Test dependencies are under `test` (singular) in pyproject.toml, not `tests`:
```
pip install -e ".[test]"
```
This differs from the other three repos which use `tests`. Harmonization is planned.

## Template Fetching

tox references `python scripts/fetch_templates.py` before tests (`commands_pre`),
but this script does not currently exist in the repo. This is a known gap --
the script needs to be created or the tox config updated.

## ASL Domain Terms

- **PLD**: Post-Labeling Delay (time between labeling and acquisition)
- **CBF**: Cerebral Blood Flow (primary output metric)
- **PCASL**: Pseudo-Continuous ASL (labeling technique)
- **PASL**: Pulsed ASL (labeling technique)
- **Single-PLD vs Multi-PLD**: one or multiple delay times
- **Label-control pairs**: alternating labeled/control images in ASL acquisition

## Key Module Paths

- ASL workflows: `aslprep/workflows/asl/` (base, cbf, confounds, fit, hmc, reference, apply, resampling, outputs, plotting)
- CBF computation: [aslprep/interfaces/cbf.py](mdc:aslprep/interfaces/cbf.py), [aslprep/utils/cbf.py](mdc:aslprep/utils/cbf.py)
- Parcellation: [aslprep/interfaces/parcellation.py](mdc:aslprep/interfaces/parcellation.py)
- ASL utilities: [aslprep/utils/asl.py](mdc:aslprep/utils/asl.py)
- Config: [aslprep/config.py](mdc:aslprep/config.py)

## Testing

- Test extras: `test` (singular) in pyproject.toml
- No pytest-xdist (no parallel test execution)
- Integration test markers defined in `[tool.pytest.ini_options]`
- FreeSurfer license fixture auto-created in conftest.py
