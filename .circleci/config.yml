version: 2.1
orbs:
  codecov: codecov/codecov@4.1.0

# ── Reusable anchors ──────────────────────────────────────────────────

_machine_defaults: &machine_defaults
  environment:
    TZ: "/usr/share/zoneinfo/America/New_York"
  machine:
    image: default
    docker_layer_caching: true
  working_directory: /tmp/src/aslprep
  resource_class: large

_docker_auth: &docker_auth
  name: Docker authentication
  command: |
    if [[ -n "$DOCKERHUB_TOKEN" ]]; then
      echo "$DOCKERHUB_TOKEN" | docker login -u $DOCKERHUB_USERNAME --password-stdin
    fi

_setup_docker_registry: &setup_docker_registry
  name: Set up local Docker registry
  command: |
    if [[ -f /tmp/images/registry.tar.gz ]]; then
      echo "Loading saved registry image"
      docker load < /tmp/images/registry.tar.gz
    else
      echo "Pulling registry image from DockerHub"
      docker pull registry:2
    fi
    docker run -d -p 5000:5000 --restart=always --name=registry \
        -v /tmp/docker:/var/lib/registry registry:2

_pull_from_registry: &pull_from_registry
  name: Pull and tag production image from local registry
  command: |
    docker pull localhost:5000/aslprep
    docker tag localhost:5000/aslprep pennlinc/aslprep:latest

_pull_test_image: &pull_test_image
  name: Pull and tag test image from local registry
  command: |
    docker pull localhost:5000/aslprep-test
    docker tag localhost:5000/aslprep-test pennlinc/aslprep:test

# ── Reusable commands ─────────────────────────────────────────────────

commands:
  restore_build_and_data:
    description: Restore Docker image cache and test data cache, then start the registry
    steps:
      - restore_cache:
          keys:
            - build-v1-{{ .Branch }}-{{ .Revision }}
      - restore_cache:
          keys:
            - data-v1-{{ .Branch }}-{{ .Revision }}
      - run: *docker_auth
      - run: *setup_docker_registry
      - run: *pull_test_image

  run_integration_test:
    description: Run a pytest-marked integration test inside the test Docker image
    parameters:
      marker:
        type: string
      cpus:
        type: integer
        default: 4
    steps:
      - run:
          name: Run aslprep (<< parameters.marker >>)
          no_output_timeout: 5h
          command: |
            mkdir -p /tmp/out /tmp/work /tmp/coverage
            # Run from the checked-out repo so pytest loads aslprep/tests/conftest.py,
            # which registers custom CLI options like --data_dir/--output_dir/--working_dir.
            docker run --rm=false \
              -e CIRCLE_CPUS=<< parameters.cpus >> \
              -e COVERAGE_FILE=/coverage/.coverage.<< parameters.marker >> \
              -v /tmp/src/aslprep:/tmp/src/aslprep:ro \
              -v /tmp/data:/data:ro \
              -v /tmp/out:/out \
              -v /tmp/work:/work \
              -v /tmp/coverage:/coverage \
              -w /tmp/src/aslprep \
              --entrypoint pytest \
              pennlinc/aslprep:test \
              -rP -o log_cli=true -m "<< parameters.marker >>" \
              --cov-append --cov-report term-missing --cov=aslprep \
              --data_dir=/data --output_dir=/out --working_dir=/work \
              aslprep/tests
      - run:
          name: Clean up large artifacts
          when: always
          command: find /tmp/out/ -name "*.nii.gz" -type f -delete 2>/dev/null || true
      - store_artifacts:
          path: /tmp/out
      - persist_to_workspace:
          root: /tmp/coverage
          paths:
            - .coverage.<< parameters.marker >>

# ── Jobs ──────────────────────────────────────────────────────────────

jobs:
  image_prep:
    <<: *machine_defaults
    environment:
      TZ: "/usr/share/zoneinfo/America/New_York"
      DOCKER_BUILDKIT: "1"
    steps:
      - checkout:
          path: /tmp/src/aslprep
      - restore_cache:
          keys:
            - build-v1-{{ .Branch }}-{{ .Revision }}
            - build-v1--{{ .Revision }}
            - build-v1-{{ .Branch }}-
            - build-v1-main-
            - build-v1-
      - run: *docker_auth
      - run: *setup_docker_registry
      - run:
          name: Get base image information
          command: |
            export BASE_IMAGE=$( grep "BASE_IMAGE=" Dockerfile | head -1 | cut -d= -f2 )
            export BASE_IMAGE_NAME=${BASE_IMAGE%:*}
            export BASE_TAG=${BASE_IMAGE#*:}
            echo "BASE_IMAGE=$BASE_IMAGE" >> $BASH_ENV
            echo "BASE_IMAGE_NAME=$BASE_IMAGE_NAME" >> $BASH_ENV
            echo "BASE_TAG=$BASE_TAG" >> $BASH_ENV
      - run:
          name: Determine whether image builds are required
          command: |
            # Always build images on main/tags for deploy correctness.
            if [[ -n "$CIRCLE_TAG" || "$CIRCLE_BRANCH" == "main" ]]; then
              echo "BUILD_PRODUCTION_IMAGE=1" >> "$BASH_ENV"
              echo "BUILD_TEST_IMAGE=1" >> "$BASH_ENV"
              exit 0
            fi

            # Prefer per-commit diffs so old branch history does not trigger
            # repeated rebuilds on unrelated follow-up commits.
            if git rev-parse --verify HEAD~1 > /dev/null 2>&1; then
              CHANGED_FILES="$(git diff --name-only HEAD~1 HEAD)"
            else
              # Fallback for shallow/special histories.
              if ! git fetch --no-tags --depth=200 origin main; then
                echo "Could not fetch origin/main; defaulting to image builds."
                echo "BUILD_PRODUCTION_IMAGE=1" >> "$BASH_ENV"
                echo "BUILD_TEST_IMAGE=1" >> "$BASH_ENV"
                exit 0
              fi
              if ! MERGE_BASE="$(git merge-base HEAD origin/main)"; then
                echo "Could not compute merge-base; defaulting to image builds."
                echo "BUILD_PRODUCTION_IMAGE=1" >> "$BASH_ENV"
                echo "BUILD_TEST_IMAGE=1" >> "$BASH_ENV"
                exit 0
              fi
              CHANGED_FILES="$(git diff --name-only "$MERGE_BASE" HEAD)"
            fi

            if printf "%s\n" "$CHANGED_FILES" | rg -q "^(Dockerfile\\.base|Dockerfile|pixi\\.lock)$"; then
              echo "BUILD_PRODUCTION_IMAGE=1" >> "$BASH_ENV"
              echo "BUILD_TEST_IMAGE=1" >> "$BASH_ENV"
            else
              echo "BUILD_PRODUCTION_IMAGE=0" >> "$BASH_ENV"
              echo "BUILD_TEST_IMAGE=0" >> "$BASH_ENV"
            fi
      - run:
          name: Build base image if needed
          no_output_timeout: 60m
          command: |
            if ! docker manifest inspect $BASE_IMAGE > /dev/null 2>&1; then
              echo "Base image $BASE_IMAGE not found, building..."
              docker build -f Dockerfile.base \
                --platform linux/amd64 \
                -t $BASE_IMAGE \
                -t $BASE_IMAGE_NAME:latest .
            else
              echo "Base image $BASE_IMAGE already exists."
            fi
      - run:
          name: Build Docker image (production)
          no_output_timeout: 3h
          command: |
            if [[ "$BUILD_PRODUCTION_IMAGE" == "1" ]]; then
              if [[ -n "$CIRCLE_TAG" ]]; then
                THISVERSION="$CIRCLE_TAG"
              else
                THISVERSION="0+build"
              fi
              sed -i "s/title = {aslprep}/title = {aslprep ${THISVERSION}}/" aslprep/data/boilerplate.bib
              e=1 && for i in {1..5}; do
                docker build \
                  --target aslprep \
                  --rm=false \
                  -t pennlinc/aslprep:latest \
                  --platform linux/amd64 \
                  --build-arg BUILD_DATE="$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
                  --build-arg VCS_REF="$(git rev-parse --short HEAD)" \
                  --build-arg VERSION="$THISVERSION" . \
                && e=0 && break || sleep 15
              done && [ "$e" -eq "0" ]
            else
              echo "Skipping production image build (no Dockerfile.base/Dockerfile/pixi.lock changes in current diff)."
            fi
      - run:
          name: Build Docker image (test)
          no_output_timeout: 60m
          command: |
            if [[ "$BUILD_TEST_IMAGE" == "1" ]]; then
              docker build \
                --target test \
                --rm=false \
                -t pennlinc/aslprep:test \
                --platform linux/amd64 .
            elif docker image inspect pennlinc/aslprep:test > /dev/null 2>&1; then
              echo "Reusing existing local test image."
            elif docker pull localhost:5000/aslprep-test; then
              docker tag localhost:5000/aslprep-test pennlinc/aslprep:test
              echo "Reusing cached test image from local registry."
            else
              echo "No reusable test image found; rebuilding test image."
              docker build \
                --target test \
                --rm=false \
                -t pennlinc/aslprep:test \
                --platform linux/amd64 .
            fi
      - run:
          name: Verify Docker images
          command: |
            if [[ "$BUILD_PRODUCTION_IMAGE" == "1" ]]; then
              docker run --rm pennlinc/aslprep:latest --version
            fi
            docker run --rm --entrypoint pytest pennlinc/aslprep:test --version
      - run:
          name: Push base image to Docker Hub (if newly built)
          command: |
            if docker image inspect $BASE_IMAGE > /dev/null 2>&1; then
              if [[ -n "$DOCKERHUB_TOKEN" ]]; then
                docker push $BASE_IMAGE
                docker push $BASE_IMAGE_NAME:latest
              fi
            fi
      - run:
          name: Push images to local registry
          no_output_timeout: 40m
          command: |
            if [[ "$BUILD_PRODUCTION_IMAGE" == "1" ]]; then
              docker tag pennlinc/aslprep:latest localhost:5000/aslprep
              docker push localhost:5000/aslprep
            fi
            docker tag pennlinc/aslprep:test localhost:5000/aslprep-test
            docker push localhost:5000/aslprep-test
      - run:
          name: Docker registry garbage collection
          command: |
            docker exec -it registry /bin/registry garbage-collect --delete-untagged \
              /etc/docker/registry/config.yml
      - save_cache:
          key: build-v1-{{ .Branch }}-{{ .Revision }}
          paths:
            - /tmp/docker
            - /tmp/images

  get_data:
    <<: *machine_defaults
    steps:
      - restore_cache:
          keys:
            - data-v1-{{ .Branch }}-{{ .Revision }}
            - data-v1--{{ .Revision }}
            - data-v1-{{ .Branch }}-
            - data-v1-main-
            - data-v1-
      - run:
          name: Download nonqtab test data
          command: |
            if [[ ! -d /tmp/data/nonqtab ]]; then
              mkdir -p /tmp/data/nonqtab
              wget --retry-connrefused --waitretry=5 --read-timeout=20 --timeout=15 -t 0 -q \
                -O /tmp/nonqtab.tar.gz \
                "https://upenn.box.com/shared/static/gmecscsr7acn1g4hawdbbkwut0ia9dud.tar.gz"
              tar xzf /tmp/nonqtab.tar.gz -C /tmp/data/nonqtab
              rm /tmp/nonqtab.tar.gz
            else
              echo "nonqtab data was cached"
            fi
      - run:
          name: Download qtab test data
          command: |
            if [[ ! -d /tmp/data/qtab ]]; then
              mkdir -p /tmp/data/qtab
              wget --retry-connrefused --waitretry=5 --read-timeout=20 --timeout=15 -t 0 -q \
                -O /tmp/qtab.tar.gz \
                "https://upenn.box.com/shared/static/ap5ftlc3logivmj03fabuahv4etqk7jf.tar.gz"
              tar xzf /tmp/qtab.tar.gz -C /tmp/data/qtab
              rm /tmp/qtab.tar.gz
            else
              echo "qtab data was cached"
            fi
      - save_cache:
          key: data-v1-{{ .Branch }}-{{ .Revision }}
          paths:
            - /tmp/data

  # ── Integration tests ────────────────────────────────────────────────

  pcasl_singlepld_philips:
    <<: *machine_defaults
    steps:
      - checkout:
          path: /tmp/src/aslprep
      - run:
          name: Check whether build should be skipped
          command: |
            if [[ "$( git log --format=oneline -n 1 $CIRCLE_SHA1 | grep -i -E '\[skip[ _]?examples_pcasl_singlepld_philips\]' )" != "" ]]; then
              echo "Skipping examples_pcasl_singlepld_philips"
              circleci step halt
            fi
      - restore_build_and_data
      - run_integration_test:
          marker: examples_pcasl_singlepld_philips
          cpus: 4

  pcasl_singlepld_siemens:
    <<: *machine_defaults
    steps:
      - checkout:
          path: /tmp/src/aslprep
      - run:
          name: Check whether build should be skipped
          command: |
            if [[ "$( git log --format=oneline -n 1 $CIRCLE_SHA1 | grep -i -E '\[skip[ _]?examples_pcasl_singlepld_siemens\]' )" != "" ]]; then
              echo "Skipping examples_pcasl_singlepld_siemens"
              circleci step halt
            fi
      - restore_build_and_data
      - run_integration_test:
          marker: examples_pcasl_singlepld_siemens
          cpus: 4

  pcasl_singlepld_ge:
    <<: *machine_defaults
    steps:
      - checkout:
          path: /tmp/src/aslprep
      - run:
          name: Check whether build should be skipped
          command: |
            if [[ "$( git log --format=oneline -n 1 $CIRCLE_SHA1 | grep -i -E '\[skip[ _]?examples_pcasl_singlepld\]' )" != "" ]]; then
              echo "Skipping examples_pcasl_singlepld_ge"
              circleci step halt
            fi
      - restore_build_and_data
      - run_integration_test:
          marker: examples_pcasl_singlepld_ge
          cpus: 2

  pcasl_multipld:
    <<: *machine_defaults
    steps:
      - checkout:
          path: /tmp/src/aslprep
      - run:
          name: Check whether build should be skipped
          command: |
            if [[ "$( git log --format=oneline -n 1 $CIRCLE_SHA1 | grep -i -E '\[skip[ _]?examples_pcasl_multipld\]' )" != "" ]]; then
              echo "Skipping examples_pcasl_multipld"
              circleci step halt
            fi
      - restore_build_and_data
      - run_integration_test:
          marker: examples_pcasl_multipld
          cpus: 4

  pasl_multipld:
    <<: *machine_defaults
    steps:
      - checkout:
          path: /tmp/src/aslprep
      - run:
          name: Check whether build should be skipped
          command: |
            if [[ "$( git log --format=oneline -n 1 $CIRCLE_SHA1 | grep -i -E '\[skip[ _]?examples_pasl_multipld\]' )" != "" ]]; then
              echo "Skipping examples_pasl_multipld"
              circleci step halt
            fi
      - restore_build_and_data
      - run_integration_test:
          marker: examples_pasl_multipld
          cpus: 2

  qtab:
    <<: *machine_defaults
    steps:
      - checkout:
          path: /tmp/src/aslprep
      - run:
          name: Check whether build should be skipped
          command: |
            if [[ "$( git log --format=oneline -n 1 $CIRCLE_SHA1 | grep -i -E '\[skip[ _]?qtab\]' )" != "" ]]; then
              echo "Skipping qtab"
              circleci step halt
            fi
      - restore_build_and_data
      - run_integration_test:
          marker: qtab
          cpus: 4

  test_001:
    <<: *machine_defaults
    steps:
      - checkout:
          path: /tmp/src/aslprep
      - run:
          name: Check whether build should be skipped
          command: |
            if [[ "$( git log --format=oneline -n 1 $CIRCLE_SHA1 | grep -i -E '\[skip[ _]?test_001\]' )" != "" ]]; then
              echo "Skipping test_001"
              circleci step halt
            fi
      - restore_build_and_data
      - run_integration_test:
          marker: test_001
          cpus: 4

  test_002:
    <<: *machine_defaults
    steps:
      - checkout:
          path: /tmp/src/aslprep
      - run:
          name: Check whether build should be skipped
          command: |
            if [[ "$( git log --format=oneline -n 1 $CIRCLE_SHA1 | grep -i -E '\[skip[ _]?test_002\]' )" != "" ]]; then
              echo "Skipping test_002"
              circleci step halt
            fi
      - restore_build_and_data
      - run_integration_test:
          marker: test_002
          cpus: 2

  test_003_minimal:
    <<: *machine_defaults
    steps:
      - checkout:
          path: /tmp/src/aslprep
      - run:
          name: Check whether build should be skipped
          command: |
            if [[ "$( git log --format=oneline -n 1 $CIRCLE_SHA1 | grep -i -E '\[skip[ _]?test_003_minimal\]' )" != "" ]]; then
              echo "Skipping test_003_minimal"
              circleci step halt
            fi
      - restore_build_and_data
      - run_integration_test:
          marker: test_003_minimal
          cpus: 4

  test_003_resampling:
    <<: *machine_defaults
    steps:
      - checkout:
          path: /tmp/src/aslprep
      - run:
          name: Check whether build should be skipped
          command: |
            if [[ "$( git log --format=oneline -n 1 $CIRCLE_SHA1 | grep -i -E '\[skip[ _]?test_003_resampling\]' )" != "" ]]; then
              echo "Skipping test_003_resampling"
              circleci step halt
            fi
      - restore_build_and_data
      - run_integration_test:
          marker: test_003_resampling
          cpus: 4

  test_003_full:
    <<: *machine_defaults
    steps:
      - checkout:
          path: /tmp/src/aslprep
      - run:
          name: Check whether build should be skipped
          command: |
            if [[ "$( git log --format=oneline -n 1 $CIRCLE_SHA1 | grep -i -E '\[skip[ _]?test_003_full\]' )" != "" ]]; then
              echo "Skipping test_003_full"
              circleci step halt
            fi
      - restore_build_and_data
      - run_integration_test:
          marker: test_003_full
          cpus: 4

  # ── Unit tests ───────────────────────────────────────────────────────

  pytests:
    <<: *machine_defaults
    steps:
      - checkout:
          path: /tmp/src/aslprep
      - run:
          name: Check whether build should be skipped
          command: |
            if [[ "$( git log --format=oneline -n 1 $CIRCLE_SHA1 | grep -i -E '\[skip[ _]?pytests\]' )" != "" ]]; then
              echo "Skipping pytests"
              circleci step halt
            fi
      - restore_build_and_data
      - run:
          name: Run pytest on tests directory
          no_output_timeout: 1h
          command: |
            mkdir -p /tmp/out /tmp/work /tmp/coverage
            # Run from the checked-out repo so pytest loads aslprep/tests/conftest.py,
            # which registers custom CLI options like --data_dir/--output_dir/--working_dir.
            docker run --rm=false \
              -e CIRCLE_CPUS=2 \
              -e COVERAGE_FILE=/coverage/.coverage.pytests \
              -v /tmp/src/aslprep:/tmp/src/aslprep:ro \
              -v /tmp/data:/data:ro \
              -v /tmp/out:/out \
              -v /tmp/work:/work \
              -v /tmp/coverage:/coverage \
              -w /tmp/src/aslprep \
              --entrypoint pytest \
              pennlinc/aslprep:test \
              --cov-append --cov-report term-missing --cov=aslprep \
              --data_dir=/data --output_dir=/out --working_dir=/work \
              aslprep/tests
      - persist_to_workspace:
          root: /tmp/coverage
          paths:
            - .coverage.pytests
      - store_artifacts:
          path: /tmp/out

  # ── Coverage & deployment ────────────────────────────────────────────

  merge_coverage:
    <<: *machine_defaults
    steps:
      - checkout:
          path: /tmp/src/aslprep
      - attach_workspace:
          at: /tmp/coverage
      - run:
          name: Merge coverage files
          command: |
            pyenv local 3
            pip install coverage
            cd /tmp/src/aslprep
            coverage combine /tmp/coverage/
            coverage xml -o /tmp/coverage/coverage.xml
      - store_artifacts:
          path: /tmp/coverage
      - run:
          name: Quick fix for GPG error in Codecov
          command: mkdir -p ~/.gnupg
      - codecov/upload:
          file: /tmp/coverage/coverage.xml

  deployable:
    docker:
      - image: busybox:latest
    steps:
      - run: echo Deploying!

  deploy_docker:
    <<: *machine_defaults
    steps:
      - checkout:
          path: /tmp/src/aslprep
      - restore_cache:
          keys:
            - build-v1-{{ .Branch }}-{{ .Revision }}
      - run: *docker_auth
      - run: *setup_docker_registry
      - run: *pull_from_registry
      - run:
          name: Deploy to Docker Hub
          no_output_timeout: 40m
          command: |
            if [[ -n "$DOCKERHUB_TOKEN" ]]; then
              docker tag pennlinc/aslprep:latest pennlinc/aslprep:unstable
              docker push pennlinc/aslprep:unstable
              if [[ -n "$CIRCLE_TAG" ]]; then
                docker tag pennlinc/aslprep:latest pennlinc/aslprep:$CIRCLE_TAG
                docker push pennlinc/aslprep:latest
                docker push pennlinc/aslprep:$CIRCLE_TAG
              fi
            fi

# ── Workflows ─────────────────────────────────────────────────────────

workflows:
  version: 2
  build_test_deploy:
    jobs:
      - image_prep:
          filters:
            tags:
              only: /.*/

      - get_data:
          filters:
            branches:
              ignore:
                - /docs?\/.*/
                - /tests?\/.*/
            tags:
              only: /.*/

      - pcasl_singlepld_philips:
          requires:
            - image_prep
            - get_data
          filters:
            branches:
              ignore:
                - /docs?\/.*/
                - /tests?\/.*/
            tags:
              only: /.*/

      - pcasl_singlepld_siemens:
          requires:
            - image_prep
            - get_data
          filters:
            branches:
              ignore:
                - /docs?\/.*/
                - /tests?\/.*/
            tags:
              only: /.*/

      - pcasl_singlepld_ge:
          requires:
            - image_prep
            - get_data
          filters:
            branches:
              ignore:
                - /docs?\/.*/
                - /tests?\/.*/
            tags:
              only: /.*/

      - pcasl_multipld:
          requires:
            - image_prep
            - get_data
          filters:
            branches:
              ignore:
                - /docs?\/.*/
                - /tests?\/.*/
            tags:
              only: /.*/

      - pasl_multipld:
          requires:
            - image_prep
            - get_data
          filters:
            branches:
              ignore:
                - /docs?\/.*/
                - /tests?\/.*/
            tags:
              only: /.*/

      - qtab:
          requires:
            - image_prep
            - get_data
          filters:
            branches:
              ignore:
                - /docs?\/.*/
                - /tests?\/.*/
            tags:
              only: /.*/

      - test_001:
          requires:
            - image_prep
            - get_data
          filters:
            branches:
              ignore:
                - /docs?\/.*/
                - /tests?\/.*/
            tags:
              only: /.*/

      - test_002:
          requires:
            - image_prep
            - get_data
          filters:
            branches:
              ignore:
                - /docs?\/.*/
                - /tests?\/.*/
            tags:
              only: /.*/

      - test_003_minimal:
          requires:
            - image_prep
            - get_data
          filters:
            branches:
              ignore:
                - /docs?\/.*/
                - /tests?\/.*/
            tags:
              only: /.*/

      - test_003_resampling:
          requires:
            - image_prep
            - get_data
          filters:
            branches:
              ignore:
                - /docs?\/.*/
                - /tests?\/.*/
            tags:
              only: /.*/

      - test_003_full:
          requires:
            - image_prep
            - get_data
          filters:
            branches:
              ignore:
                - /docs?\/.*/
                - /tests?\/.*/
            tags:
              only: /.*/

      - pytests:
          requires:
            - image_prep
            - get_data
          filters:
            branches:
              ignore:
                - /docs?\/.*/
                - /tests?\/.*/
            tags:
              only: /.*/

      - merge_coverage:
          requires:
            - pcasl_singlepld_philips
            - pcasl_singlepld_siemens
            - pcasl_singlepld_ge
            - pcasl_multipld
            - pasl_multipld
            - qtab
            - test_001
            - test_002
            - test_003_minimal
            - test_003_resampling
            - test_003_full
            - pytests
          filters:
            branches:
              ignore:
                - /docs?\/.*/
                - /tests?\/.*/
            tags:
              only: /.*/

      - deployable:
          requires:
            - image_prep
            - pcasl_singlepld_philips
            - pcasl_singlepld_siemens
            - pcasl_singlepld_ge
            - pcasl_multipld
            - pasl_multipld
            - qtab
            - test_001
            - test_002
            - test_003_minimal
            - test_003_resampling
            - test_003_full
          filters:
            branches:
              only: main
            tags:
              only: /.*/

      - deploy_docker:
          requires:
            - deployable
          filters:
            branches:
              only: main
            tags:
              only: /.*/
